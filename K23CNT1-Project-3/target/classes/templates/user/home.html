<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{user/fragments/user-layout :: head}"></head>

<body class="bg-gray-50">
    <!-- Navbar -->
    <nav th:replace="~{user/fragments/user-layout :: navbar}"></nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Banner Carousel -->
        <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl relative">
            <div th:if="${banners != null and !banners.isEmpty()}" class="relative h-[400px] bg-gray-900">
                <!-- Banner Slides -->
                <div th:each="banner, iterStat : ${banners}" 
                     th:id="'banner-' + ${iterStat.index}"
                     th:class="${iterStat.index == 0} ? 
                               'absolute inset-0 transition-opacity duration-1000 banner-slide opacity-100 z-10' : 
                               'absolute inset-0 transition-opacity duration-1000 banner-slide opacity-0 z-0'">
                    <img th:src="${banner.imageUrl}" 
                         th:alt="${banner.name}"
                         class="w-full h-full object-contain">
                    <!-- Gradient overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                </div>
                
                <!-- Navigation Dots -->
                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-3 z-20">
                    <button th:each="banner, iterStat : ${banners}" 
                            th:onclick="'goToBanner(' + ${iterStat.index} + ')'"
                            th:id="'dot-' + ${iterStat.index}"
                            th:class="${iterStat.index == 0} ? 'banner-dot w-3 h-3 rounded-full bg-white transition-all' : 'banner-dot w-3 h-3 rounded-full bg-white/50 transition-all'"
                            class="hover:bg-white cursor-pointer"></button>
                </div>
                
                <!-- Navigation Arrows -->
                <button onclick="previousBanner()" 
                        class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white transition-all z-20">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button onclick="nextBanner()" 
                        class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center text-white transition-all z-20">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- Fallback if no banners -->
            <div th:if="${banners == null or banners.isEmpty()}" class="relative h-[400px] bg-gradient-to-br from-primary-500 to-blue-400">
                <div class="absolute inset-0 flex items-center justify-center text-white">
                    <div class="text-center px-4">
                        <div class="mb-6">
                            <i class="fas fa-store text-7xl mb-4 animate-pulse"></i>
                        </div>
                        <h1 class="text-5xl md:text-6xl font-bold mb-4 drop-shadow-lg">
                            Chào mừng đến RA1NEE STORE
                        </h1>
                        <p class="text-xl md:text-2xl mb-8 drop-shadow-md">
                            Linh kiện máy tính chính hãng - Giá tốt nhất thị trường
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Products Section -->
        <div id="products" class="mb-8">
            <!-- Header with Filter Toggle -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-fire text-red-500"></i>
                    Sản phẩm hot
                </h2>
                <button onclick="toggleFilter()" 
                        class="px-4 py-2 bg-white border-2 border-primary-500 text-primary-500 hover:bg-primary-50 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fas fa-filter"></i>
                    <span>Bộ lọc</span>
                </button>
            </div>

            <!-- Collapsible Filter Panel -->
            <div id="filterPanel" class="hidden mb-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Bộ lọc sản phẩm</h3>
                    
                    <form action="/home" method="get" class="grid grid-cols-1 gap-4">
                        <!-- Category Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Danh mục</label>
                            <select name="categoryId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="">Tất cả</option>
                                <option th:each="cat : ${categories}" 
                                        th:value="${cat.id}" 
                                        th:text="${cat.name}"
                                        th:selected="${cat.id == categoryId}">Category</option>
                            </select>
                        </div>
                        
                        <!-- Price Range Slider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Khoảng giá</label>
                            <div class="px-2">
                                <div id="priceSlider" class="mb-6"></div>
                                <div class="flex items-center justify-between text-sm text-gray-600">
                                    <span id="minPriceDisplay">100,000₫</span>
                                    <span id="maxPriceDisplay">100,000,000₫</span>
                                </div>
                            </div>
                            <input type="hidden" name="minPrice" id="minPriceInput" th:value="${minPrice != null ? minPrice : 100000}">
                            <input type="hidden" name="maxPrice" id="maxPriceInput" th:value="${maxPrice != null ? maxPrice : 100000000}">
                        </div>
                        
                        <!-- Buttons -->
                        <div class="flex gap-3">
                            <button type="submit" class="px-6 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-check mr-2"></i> Áp dụng
                            </button>
                            <a href="/home" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">
                                <i class="fas fa-redo mr-2"></i> Reset
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div th:each="product : ${nnhProducts}" 
                     class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-all hover:-translate-y-1 overflow-hidden group flex flex-col h-full">
                    
                    <!-- Image Link -->
                    <a th:href="@{/product/{id}(id=${product.id})}" class="block relative h-48 bg-white overflow-hidden flex-shrink-0 border-b border-gray-100">
                        <img th:if="${product.imageUrl != null}" 
                             th:src="${product.imageUrl}" 
                             th:alt="${product.name}"
                             class="w-full h-full object-contain p-2 group-hover:scale-110 transition-transform duration-300" />
                        <div th:unless="${product.imageUrl != null}" 
                             class="w-full h-full flex items-center justify-center">
                            <i class="fas fa-image text-6xl text-gray-300"></i>
                        </div>
                        
                        <!-- Sale Badge -->
                        <div th:if="${product.salePrice != null}" 
                             class="absolute top-2 right-2 px-3 py-1 bg-red-500 text-white text-sm font-bold rounded-full">
                            SALE
                        </div>
                    </a>
                    
                    <!-- Content -->
                    <div class="p-4 flex flex-col flex-1">
                        <!-- Title Link -->
                        <a th:href="@{/product/{id}(id=${product.id})}" class="block mb-2">
                            <h3 class="font-medium text-gray-900 line-clamp-2 min-h-[3rem] hover:text-primary-600 transition-colors" 
                                th:text="${product.name}">Product Name</h3>
                        </a>
                        
                        <!-- Price -->
                        <div class="mb-3">
                            <div th:if="${product.salePrice != null}">
                                <span class="text-sm text-gray-400 line-through" 
                                      th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></span>
                                <div class="text-xl font-bold text-red-600" 
                                     th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + '₫'"></div>
                            </div>
                            <div th:if="${product.salePrice == null}" 
                                 class="text-xl font-bold text-gray-900"
                                 th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></div>
                        </div>
                        
                        <!-- Stock & Add to Cart Button -->
                        <div class="mt-auto flex items-center justify-between">
                            <div>
                                <span th:if="${product.stockQuantity > 0}" class="text-sm text-green-600">
                                    <i class="fas fa-check-circle"></i> Còn hàng
                                </span>
                                <span th:unless="${product.stockQuantity > 0}" class="text-sm text-red-600">
                                    <i class="fas fa-times-circle"></i> Hết hàng
                                </span>
                            </div>
                            
                            <!-- Add to Cart Link -->
                            <a th:if="${product.stockQuantity > 0}" 
                               th:href="@{/product/{id}(id=${product.id})}"
                               class="w-10 h-10 rounded-full bg-primary-500 hover:bg-primary-600 text-white flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                                <i class="fas fa-plus text-lg"></i>
                            </a>
                            <div th:unless="${product.stockQuantity > 0}" 
                                 class="w-10 h-10 rounded-full bg-gray-300 text-white flex items-center justify-center opacity-50 pointer-events-none">
                                <i class="fas fa-plus text-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${nnhProducts.isEmpty()}" class="col-span-full text-center py-16">
                    <i class="fas fa-inbox text-8xl text-gray-300 mb-4"></i>
                    <p class="text-xl text-gray-500">Không tìm thấy sản phẩm nào</p>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${totalPages > 1}" class="mt-8 flex justify-center items-center gap-2">
                <!-- Previous Button -->
                <a th:if="${currentPage > 0}" 
                   th:href="@{/home(page=${currentPage - 1}, categoryId=${categoryId}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                   class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <span th:unless="${currentPage > 0}" 
                      class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-400 cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </span>

                <!-- Page Numbers -->
                <div class="flex gap-2">
                    <a th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                       th:href="@{/home(page=${i}, categoryId=${categoryId}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       th:class="${i == currentPage} ? 'px-4 py-2 border border-gray-300 rounded-lg transition-colors bg-primary-500 text-white' : 'px-4 py-2 border border-gray-300 rounded-lg transition-colors bg-white text-gray-700 hover:bg-gray-50'"
                       th:text="${i + 1}">1</a>
                </div>

                <!-- Next Button -->
                <a th:if="${currentPage < totalPages - 1}" 
                   th:href="@{/home(page=${currentPage + 1}, categoryId=${categoryId}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                   class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-chevron-right"></i>
                </a>
                <span th:unless="${currentPage < totalPages - 1}" 
                      class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-400 cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{user/fragments/user-layout :: footer}"></footer>

    <!-- Scripts -->
    <div th:replace="~{user/fragments/user-layout :: scripts}"></div>
    
    <!-- noUiSlider CSS & JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    
    <script>
        // Banner Carousel
        let currentBanner = 0;
        const banners = document.querySelectorAll('.banner-slide');
        const dots = document.querySelectorAll('.banner-dot');
        
        function goToBanner(index) {
            banners.forEach(banner => {
                banner.classList.remove('opacity-100', 'z-10');
                banner.classList.add('opacity-0', 'z-0');
            });
            if (banners[index]) {
                banners[index].classList.remove('opacity-0', 'z-0');
                banners[index].classList.add('opacity-100', 'z-10');
            }
            dots.forEach(dot => {
                dot.classList.remove('bg-white');
                dot.classList.add('bg-white/50');
            });
            if (dots[index]) {
                dots[index].classList.remove('bg-white/50');
                dots[index].classList.add('bg-white');
            }
            currentBanner = index;
        }
        
        function nextBanner() {
            currentBanner = (currentBanner + 1) % banners.length;
            goToBanner(currentBanner);
        }
        
        function previousBanner() {
            currentBanner = (currentBanner - 1 + banners.length) % banners.length;
            goToBanner(currentBanner);
        }
        
        // Auto-rotate every 3 seconds
        if (banners.length > 1) {
            setInterval(() => {
                nextBanner();
            }, 3000);
        }
        
        // Toggle Filter
        function toggleFilter() {
            const filterPanel = document.getElementById('filterPanel');
            if(filterPanel) {
                filterPanel.classList.toggle('hidden');
            }
        }
        
        // Initialize price slider
        document.addEventListener('DOMContentLoaded', function() {
            var priceSlider = document.getElementById('priceSlider');
            if(priceSlider) {
                var minPriceInput = document.getElementById('minPriceInput');
                var maxPriceInput = document.getElementById('maxPriceInput');
                var minPriceDisplay = document.getElementById('minPriceDisplay');
                var maxPriceDisplay = document.getElementById('maxPriceDisplay');
                
                // Get current values or defaults
                var currentMin = minPriceInput.value ? parseInt(minPriceInput.value) : 100000;
                var currentMax = maxPriceInput.value ? parseInt(maxPriceInput.value) : 100000000;
                
                noUiSlider.create(priceSlider, {
                    start: [currentMin, currentMax],
                    connect: true,
                    step: 100000,
                    range: {
                        'min': 100000,
                        'max': 100000000
                    },
                    format: {
                        to: function(value) {
                            return Math.round(value);
                        },
                        from: function(value) {
                            return Number(value);
                        }
                    }
                });

                priceSlider.noUiSlider.on('update', function(values, handle) {
                    var min = parseInt(values[0]);
                    var max = parseInt(values[1]);
                    
                    if(minPriceDisplay) minPriceDisplay.textContent = min.toLocaleString('vi-VN') + '₫';
                    if(maxPriceDisplay) maxPriceDisplay.textContent = max.toLocaleString('vi-VN') + '₫';
                    if(minPriceInput) minPriceInput.value = min;
                    if(maxPriceInput) maxPriceInput.value = max;
                });
            }
        });
    </script>
</body>

</html>